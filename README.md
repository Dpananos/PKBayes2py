This branch has the simulation working.